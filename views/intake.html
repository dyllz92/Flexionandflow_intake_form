<!doctype html>
<html lang="en" data-brand="flexion">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client Intake Form - Flexion &amp; Flow</title>
    <link rel="stylesheet" href="/css/styles.css?v=20260203" />
    <link rel="stylesheet" href="/css/forms.css?v=20260203" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="/js/brand.js?v=20260127"></script>
  </head>
  <body data-brand="flexion">
    <div class="container" data-testid="app-shell">
      <div class="form-header">
        <img
          src="/img/Flexion_Flow_Logo.png"
          alt="Flexion &amp; Flow Logo"
          class="logo-small"
        />
        <h1 id="formTitle">Client Intake Form</h1>
      </div>

      <!-- Intro Text -->
      <div
        class="info-box"
        style="
          margin-bottom: 24px;
          background: linear-gradient(
            135deg,
            rgba(157, 78, 221, 0.08) 0%,
            rgba(30, 136, 199, 0.08) 100%
          );
          padding: 16px;
          border-radius: 12px;
        "
      >
        <p style="margin: 0; font-size: 14px; color: var(--text-dark); line-height: 1.5;">
          Welcome! Please complete this intake form to help us provide you with the best possible service.
        </p>
      </div>

      <!-- Step Indicator -->
      <div id="stepIndicator" class="step-indicator">
        <div class="step active" data-step="1">
          <span class="step-number">1</span>
          <span class="step-label">Your Details</span>
        </div>
        <div class="step" data-step="2">
          <span class="step-number">2</span>
          <span class="step-label">About Your Visit</span>
        </div>
        <div class="step" data-step="3">
          <span class="step-number">3</span>
          <span class="step-label">Health History</span>
        </div>
        <div class="step" data-step="4">
          <span class="step-number">4</span>
          <span class="step-label">Pain &amp; Signals</span>
        </div>
        <div class="step" data-step="5">
          <span class="step-number">5</span>
          <span class="step-label">Consents</span>
        </div>
      </div>
      <div id="stepCount" class="step-count" aria-live="polite">
        Step 1 of 5
      </div>
      <div
        id="stepValidationMessage"
        class="step-validation-message"
        role="status"
        aria-live="polite"
      ></div>

      <form
        id="intakeForm"
        class="intake-form wizard-form"
        data-testid="intake-form"
      >
        <!-- Hidden field for selected brand -->
        <input
          type="hidden"
          id="selectedBrand"
          name="selectedBrand"
          value="flexion"
        />

        <!-- Step 1: Your Details -->
        <div class="wizard-step form-section active" data-step="1" data-testid="intake-step-1">
          <h2>Step 1 - Your Details</h2>

          <div class="form-row" style="display: flex; gap: 12px">
            <div class="form-group" style="flex: 1">
              <label for="firstName"
                >First Name: <span class="required">*</span></label
              >
              <input
                type="text"
                id="firstName"
                name="firstName"
                data-testid="firstName"
                required
              />
            </div>
            <div class="form-group" style="flex: 1">
              <label for="lastName"
                >Last Name: <span class="required">*</span></label
              >
              <input
                type="text"
                id="lastName"
                name="lastName"
                data-testid="lastName"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="preferredName"
              >Preferred name
              <span style="font-weight: normal; font-size: 13px; color: var(--text-light);">(optional)</span></label
            >
            <input
              type="text"
              id="preferredName"
              name="preferredName"
              placeholder="What would you like to be called?"
              maxlength="50"
            />
          </div>

          <div class="form-group">
            <label for="pronouns"
              >Pronouns
              <span style="font-weight: normal; font-size: 13px; color: var(--text-light);">(optional)</span></label
            >
            <select id="pronouns" name="pronouns" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; background: var(--input-bg);">
              <option value="">Select pronouns...</option>
              <option value="She/Her">She/Her</option>
              <option value="He/Him">He/Him</option>
              <option value="They/Them">They/Them</option>
            </select>
          </div>

          <div class="form-group hidden-field" id="pronounsSelfDescribeGroup" style="display: none;">
            <label for="pronounsSelfDescribe"
              >Please describe your pronouns:</label>
          </div>

          <div class="form-group">
            <label for="gender"
              >Gender
              <span style="font-weight: normal; font-size: 13px; color: var(--text-light);">(optional)</span></label
            >
            <div class="radio-group inline compact">
              <label><input type="radio" name="gender" value="Male" />Male</label>
              <label><input type="radio" name="gender" value="Female" />Female</label>
              <label><input type="radio" name="gender" value="Non-binary" />Non-binary</label>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email: <span class="required">*</span></label>
            <input
              type="email"
              id="email"
              name="email"
              data-testid="email"
              required
            />
          </div>

          <div class="form-group">
            <label for="mobile">Phone: <span class="required">*</span></label>
            <input
              type="tel"
              id="mobile"
              name="mobile"
              data-testid="mobile"
              placeholder="e.g. 0412 345 678"
              required
            />
            <div class="form-error" id="error-mobile"></div>
          </div>

          <div class="form-group">
            <label for="dateOfBirth"
              >Date of Birth: <span class="required">*</span></label
            >
            <input
              type="text"
              id="dateOfBirth"
              name="dateOfBirth"
              data-testid="dateOfBirth"
              class="date-input"
              placeholder="DD/MM/YYYY"
              inputmode="numeric"
              autocomplete="bday"
              data-max-date="today"
              required
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                font-size: 16px;
                background: var(--input-bg);
              "
            />
            <p style="font-size: 13px; color: var(--text-light); margin-top: 4px;">
              Used to confirm identity and tailor treatment.
            </p>
          </div>

          <h3
            style="
              margin-top: 28px;
              margin-bottom: 16px;
              font-size: 16px;
              color: var(--primary-color);
            "
          >
            Emergency Contact
            <span
              style="
                font-weight: normal;
                font-size: 13px;
                color: var(--text-light);
              "
              >(Optional)</span
            >
          </h3>

          <div class="form-group">
            <label for="emergencyName">Emergency Contact Name:</label>
            <input type="text" id="emergencyName" name="emergencyName" />
          </div>

          <div class="form-group">
            <label for="emergencyRelationship">Relationship:</label>
            <input
              type="text"
              id="emergencyRelationship"
              name="emergencyRelationship"
              placeholder="e.g., Partner, Parent, Friend"
            />
          </div>

          <div class="form-group">
            <label for="emergencyPhone">Emergency Contact Phone:</label>
            <input
              type="tel"
              id="emergencyPhone"
              name="emergencyPhone"
              placeholder="e.g., 0412 345 678"
            />
          </div>

          <div
            style="
              margin-top: 24px;
              padding-top: 16px;
              border-top: 1px solid var(--border-color);
              text-align: center;
            "
          >
            <p style="font-size: 13px; color: var(--text-light); margin: 0">
              All details filled in? Click <strong>Next</strong> to continue.
            </p>
          </div>
        </div>

        <!-- Step 2: About Your Visit & Lifestyle -->
        <div class="wizard-step form-section" data-step="2" data-testid="intake-step-2">
          <h2>Step 2 - About Your Visit</h2>

          <div class="form-group">
            <label
              >What brings you to see me today?
              <span class="required">*</span></label
            >
            <p
              style="
                font-size: 13px;
                color: var(--text-light);
                margin: 4px 0 12px 0;
              "
            >
              Select all that apply
            </p>
            <div class="radio-group grid-4-3" style="margin-bottom: 12px;">
              <div class="grid-left">
                <label>
                  <input type="radio" name="visitGoals" value="Pain / Tension relief" />
                  Pain / Tension relief
                </label>
                <label>
                  <input type="radio" name="visitGoals" value="Injury recovery" />
                  Injury recovery
                </label>
                <label>
                  <input type="radio" name="visitGoals" value="Improve mobility" />
                  Improve mobility
                </label>
              </div>
              <div class="grid-right">
                <label>
                  <input type="radio" name="visitGoals" value="Releive Stress" />
                  Releive stress
                </label>
                <label>
                  <input type="radio" name="visitGoals" value="Training for an event" />
                  Training for an event
                </label>
                <label>
                  <input type="radio" name="visitGoals" value="Improve sleep" />
                  Improve sleep
                </label>
              </div>
            </div>
            <div class="form-group hidden-field" style="margin-top: 12px;">
              <label for="visitGoalOther">Anything else? (optional)</label>
              <input
                type="text"
                id="visitGoalOther"
                name="visitGoalOther"
                placeholder="Please tell me what brings you in today"
                maxlength="200"
              />
            </div>
          </div>

          <div class="form-group">
            <label
              >How did you hear about me? <span class="required">*</span></label
            >
            <div class="radio-group grid-2-3">
              <div class="grid-left">
                <label>
                  <input
                    type="radio"
                    name="referralSource"
                    value="Google"
                    required
                  />
                  Google
                </label>
                <label>
                  <input
                    type="radio"
                    name="referralSource"
                    value="Word of mouth"
                  />
                  Word of mouth
                </label>
                <label>
                  <input
                    type="radio"
                    name="referralSource"
                    value="Advertisement"
                  />
                  Advertisement
                </label>
              </div>
              <div class="grid-right">
                </label>
                <label>
                  <input
                    type="radio"
                    name="referralSource"
                    value="I was referred by someone"
                  />
                  I was referred by someone
                </label>
              </div>
            </div>
          </div>

          <div
            id="referralPersonSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="referral_person"
              >Who referred you? <span class="optional">(Optional)</span></label
            >
            <input
              type="text"
              id="referral_person"
              name="referral_person"
              placeholder="Name of person or practitioner who referred you"
              maxlength="100"
            />
          </div>

          <h3
            style="
              margin-top: 28px;
              margin-bottom: 16px;
              font-size: 16px;
              color: var(--primary-color);
            "
          >
            Lifestyle
          </h3>

          <div class="form-group">
            <label for="occupation"
              >What do you do for work? <span class="required">*</span></label
            >
            <input
              type="text"
              id="occupation"
              name="occupation"
              data-testid="occupation"
              placeholder="e.g., Office Worker, Tradie, Student"
              maxlength="100"
              required
            />
          </div>

          <div class="form-group slider-group">
            <label
              >How well do you sleep? <span class="required">*</span></label
            >
            <div class="slider-container">
              <input
                type="range"
                id="sleepQuality"
                name="sleepQuality"
                min="1"
                max="10"
                value=""
                class="slider-input"
                required
                data-testid="sleepQuality"
              />
              <div class="slider-labels">
                <span>1 - Terrible</span>
                <span>10 - Fantastic</span>
              </div>
              <div class="slider-value" id="sleepQualityValue"></div>
            </div>
          </div>

          <div class="form-group slider-group">
            <label
              >How are your stress levels?
              <span class="required">*</span></label
            >
            <div class="slider-container">
              <input
                type="range"
                id="stressLevel"
                name="stressLevel"
                min="1"
                max="10"
                value=""
                class="slider-input"
                required
                data-testid="stressLevel"
              />
              <div class="slider-labels">
                <span>1 - Low</span>
                <span>10 - High</span>
              </div>
              <div class="slider-value" id="stressLevelValue"></div>
            </div>
          </div>

          <div class="form-group">
            <label
              >How often do you exercise? <span class="required">*</span></label
            >
            <div class="radio-group compact grid-3-3">
              <div class="grid-left">
                <label
                  ><input
                    type="radio"
                    name="exerciseFrequency"
                    value="Never"
                    required
                  />
                  Never</label
                >
                <label
                  ><input
                    type="radio"
                    name="exerciseFrequency"
                    value="Rarely (few times a month)"
                  />
                  Rarely (few times a month)</label
                >
                <label
                  ><input
                    type="radio"
                    name="exerciseFrequency"
                    value="1-2 days per week"
                  />
                  1-2 days per week</label
                >
              </div>
              <div class="grid-right">
                <label
                  ><input
                    type="radio"
                    name="exerciseFrequency"
                    value="3-4 days per week"
                  />
                  3-4 days per week</label
                >
                <label
                  ><input
                    type="radio"
                    name="exerciseFrequency"
                    value="5+ days per week"
                  />
                  5+ days per week</label
                >
                <label
                  ><input type="radio" name="exerciseFrequency" value="Daily" />
                  Daily</label
                >
              </div>
            </div>
          </div>

          <div
            id="exerciseDetailsSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="exerciseDetails"
              >Tell me more about your exercise routine
              <span class="optional">(Optional)</span></label
            >
            <input
              type="text"
              id="exerciseDetails"
              name="exerciseDetails"
              placeholder="e.g., Soccer 3x/week, Gym workouts, Running, Yoga classes"
              maxlength="150"
            />
          </div>

          <h3
            style="
              margin-top: 28px;
              margin-bottom: 16px;
              font-size: 16px;
              color: var(--primary-color);
            "
          >
            Previous Massage Experience
          </h3>

          <div class="form-group">
            <label
              >Do you have any previous experience with Massage Therapy?
              <span class="required">*</span></label
            >
            <div class="radio-group inline compact">
              <label
                ><input
                  type="radio"
                  name="previousMassage"
                  value="Yes"
                  required
                />
                Yes</label
              >
              <label
                ><input type="radio" name="previousMassage" value="No" />
                No</label
              >
            </div>
          </div>

          <div
            id="lastTreatmentSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label
              >When was your last treatment?
              <span class="optional">(Optional)</span></label
            >
            <div class="radio-group compact grid-3-2">
              <div class="grid-left">
                <label
                  ><input
                    type="radio"
                    name="last_treatment_when"
                    value="2-3 weeks ago"
                  />
                  2-3 weeks ago</label
                >
                <label
                  ><input
                    type="radio"
                    name="last_treatment_when"
                    value="About a month ago"
                  />
                  About a month ago</label
                >
                <label
                  ><input
                    type="radio"
                    name="last_treatment_when"
                    value="A few months ago"
                  />
                  A few months ago</label
                >
              </div>
              <div class="grid-right">
                <label
                  ><input
                    type="radio"
                    name="last_treatment_when"
                    value="A long time ago"
                  />
                  A long time ago</label
                >
                <label
                  ><input
                    type="radio"
                    name="last_treatment_when"
                    value="I'm embarrassed to say"
                  />
                  I'm embarrassed to say</label
                >
              </div>
            </div>
          </div>


        </div>

        <!-- Step 4: Pain & Signals -->
        <div class="wizard-step form-section" data-step="4" data-testid="intake-step-4">
          <h2>Step 4 - Pain &amp; Signals</h2>
          <p class="section-note">
            Help me understand what's going on with your body today.
          </p>

          <div class="form-group slider-group">
            <label>Pain or discomfort level today <span class="optional">(Optional)</span></label>
            <div class="slider-container">
              <input
                type="range"
                id="painLevel"
                name="painLevel"
                min="0"
                max="10"
                value=""
                class="slider-input"
                data-testid="pain-slider"
              />
              <div class="slider-labels">
                <span>0 - None</span>
                <span>10 - Worst</span>
              </div>
              <div class="slider-value" id="painLevelValue"></div>
            </div>
            <div style="margin-top: 8px;">
              <label style="display: flex; align-items: center; font-weight: normal;">
                <input type="checkbox" name="painNotSure" data-testid="pain-not-sure" /> Not sure
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Was this caused by an accident, or is it an ongoing issue? <span class="optional">(Optional)</span></label>
            <div class="radio-group inline compact">
              <label><input type="radio" name="painCause" value="accident" /> Accident or specific incident</label>
              <label><input type="radio" name="painCause" value="ongoing" /> Ongoing issue</label>
              <label><input type="radio" name="painCause" value="not_sure" /> Not sure</label>
            </div>
          </div>

          <div class="form-group" id="painDescriptorsGroup">
            <label>Anything else that describes it? <span class="optional">(Optional)</span></label>
            <div class="chip-group" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="It comes and goes" style="margin-right: 6px;" />
                It comes and goes
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Worse with sitting" style="margin-right: 6px;" />
                Worse with sitting
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Worse with exercise" style="margin-right: 6px;" />
                Worse with exercise
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Better with movement" style="margin-right: 6px;" />
                Better with movement
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Worse in the morning" style="margin-right: 6px;" />
                Worse in the morning
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Worse at the end of the day" style="margin-right: 6px;" />
                Worse at the end of the day
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Pins and needles" style="margin-right: 6px;" />
                Pins and needles
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Numbness" style="margin-right: 6px;" />
                Numbness
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="Headaches" style="margin-right: 6px;" />
                Headaches
              </label>
              <label style="display: inline-flex; align-items: center; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 14px;">
                <input type="checkbox" name="painDescriptors" value="tell_in_person" data-testid="tell-in-person" style="margin-right: 6px;" />
                I'd rather tell you in person
              </label>
            </div>
            <div class="form-group" id="painDescriptorOtherSection" style="margin-top: 12px;">
              <label for="painDescriptorOther">Other (optional)</label>
              <input
                type="text"
                id="painDescriptorOther"
                name="painDescriptorOther"
                placeholder="Describe what else is happening..."
                maxlength="200"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Is today worse than usual? <span class="optional">(Optional)</span></label>
            <div class="radio-group inline compact" data-testid="worse-than-usual">
              <label><input type="radio" name="worseToday" value="Yes" /> Yes</label>
              <label><input type="radio" name="worseToday" value="No" /> No</label>
              <label><input type="radio" name="worseToday" value="Not sure" /> Not sure</label>
            </div>
          </div>

          <div class="form-group">
            <label>Pressure preference <span class="optional">(Optional)</span></label>
            <div class="radio-group inline compact" data-testid="pressure-preference">
              <label><input type="radio" name="pressurePreference" value="Light" /> Light</label>
              <label><input type="radio" name="pressurePreference" value="Medium" /> Medium</label>
              <label><input type="radio" name="pressurePreference" value="Firm" /> Firm</label>
              <label><input type="radio" name="pressurePreference" value="Not sure" /> Not sure</label>
            </div>
          </div>

          <div class="form-group">
            <label for="areasToAvoid">Any areas you'd prefer I avoid? <span class="optional">(Optional)</span></label>
            <textarea
              id="areasToAvoid"
              name="areasToAvoid"
              data-testid="areas-to-avoid"
              rows="2"
              maxlength="500"
              placeholder="e.g., Lower back due to recent strain, neck is sensitive..."
              style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; font-family: inherit;"
            ></textarea>
          </div>

          <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-color); font-size: 1.1em;">Where are you experiencing discomfort?</h3>
          <div class="muscle-map-container">
            <canvas id="muscleMapCanvas" class="muscle-map-canvas"></canvas>
            <button type="button" id="clearMuscleMap" class="btn-secondary">Clear Muscle Map</button>
            <button type="button" id="expandBodyMap" class="btn-secondary">Expand Body Map</button>
            <input type="hidden" id="muscleMapMarks" name="muscleMapMarks" value="[]">
          </div>
            <button type="button" id="expandBodyMap" class="btn-secondary">Expand Body Map</button>
            <input type="hidden" id="muscleMapMarks" name="muscleMapMarks" value="[]">
          </div>

          <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
            <p style="font-size: 13px; color: var(--text-light); margin: 0">
              Click <strong>Next</strong> to continue.
            </p>
          </div>
        </div>

        <!-- Body Map Expand Modal -->
        <div id="bodyMapModal" class="body-map-modal hidden-field" role="dialog" aria-modal="true" aria-labelledby="bodyMapModalTitle">
          <div class="body-map-backdrop"></div>
          <div class="body-map-content" role="document">
            <div class="body-map-header">
              <h2 id="bodyMapModalTitle">Body Map - Tap to mark areas of discomfort</h2>
              <button type="button" id="closeBodyMapBtn" class="btn-secondary" aria-label="Close Body Map">Close</button>
            </div>
            <div class="body-map-body">
              <div id="muscleMapContainerExpanded"></div>
              <div class="body-map-controls">
                <button type="button" id="zoomInBtn" class="btn-secondary">Zoom In (+)</button>
                <button type="button" id="zoomOutBtn" class="btn-secondary">Zoom Out (-)</button>
                <button type="button" id="resetZoomBtn" class="btn-secondary">Reset View</button>
                <button type="button" id="clearMuscleMapExpanded" class="btn-secondary">Clear All</button>
              </div>
            </div>
          </div>
        </div>
        <script src="/js/muscleMap.js?v=20260203" defer></script>
        <script src="/js/bodyMapModal.js?v=20260203" defer></script>

        <!-- Step 3: Health & Medical History -->
        <div class="wizard-step form-section" data-step="3" data-testid="intake-step-3">
          <h2>Step 3 - Health History</h2>
          <p class="section-note">
            This information helps ensure your safety and allows me to tailor
            your treatment.
          </p>

          <div class="form-group">
            <label
              >Are you taking any medications?
              <span class="required">*</span></label
            >
            <div class="radio-group inline">
              <label
                ><input
                  type="radio"
                  name="takingMedications"
                  value="Yes"
                  required
                />
                Yes</label
              >
              <label
                ><input type="radio" name="takingMedications" value="No" />
                No</label
              >
            </div>
          </div>

          <div
            id="medicationsSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="medicationsList"
              >Please list medications here:
              <span class="required">*</span></label
            >
            <textarea
              id="medicationsList"
              name="medicationsList"
              rows="2"
              maxlength="500"
              placeholder="e.g., Blood pressure medication, pain relievers, etc."
            ></textarea>
          </div>

          <div class="form-group">
            <label
              >Do you have any allergies? <span class="required">*</span></label
            >
            <div class="radio-group inline">
              <label
                ><input type="radio" name="hasAllergies" value="Yes" required />
                Yes</label
              >
              <label
                ><input type="radio" name="hasAllergies" value="No" /> No</label
              >
            </div>
          </div>

          <div
            id="allergiesSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="allergiesList"
              >Please list allergies here:
              <span class="required">*</span></label
            >
            <textarea
              id="allergiesList"
              name="allergiesList"
              rows="2"
              maxlength="500"
              placeholder="e.g., Nuts, latex, fragrances, certain oils, etc."
            ></textarea>
          </div>

          <h3
            style="
              margin-top: 28px;
              margin-bottom: 16px;
              font-size: 16px;
              color: var(--primary-color);
            "
          >
            Accidents, Injuries, Surgeries &amp; Conditions
          </h3>

          <div class="form-group">
            <label
              >Have you had any recent accidents, injuries or surgeries?
              <span class="required">*</span></label
            >
            <div class="radio-group inline">
              <label
                ><input
                  type="radio"
                  name="hasRecentInjuries"
                  value="Yes"
                  required
                />
                Yes</label
              >
              <label
                ><input type="radio" name="hasRecentInjuries" value="No" />
                No</label
              >
            </div>
          </div>

          <div class="form-group">
            <label
              >Do you have any of the following?
              <span class="required">*</span></label
            >
            <p
              style="
                font-size: 13px;
                color: var(--text-light);
                margin: 4px 0 12px 0;
              "
            >
              Select all that apply. This helps me tailor your treatment safely.
            </p>
            <div class="checkbox-group">
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Arthritis"
                />
                Arthritis</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Asthma / Respiratory conditions"
                />
                Asthma / Respiratory conditions</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Blood clots / DVT"
                />
                Blood clots / DVT</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Cancer (current or history)"
                />
                Cancer (current or history)</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Chronic pain"
                />
                Chronic pain</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Diabetes"
                />
                Diabetes</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Epilepsy / Seizures"
                />
                Epilepsy / Seizures</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Fibromyalgia"
                />
                Fibromyalgia</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Heart condition"
                />
                Heart condition</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="High / Low blood pressure"
                />
                High / Low blood pressure</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Migraines / Headaches"
                />
                Migraines / Headaches</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Osteoporosis"
                />
                Osteoporosis</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Skin conditions (eczema, psoriasis, etc.)"
                />
                Skin conditions (eczema, psoriasis, etc.)</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="Other"
                />
                Other</label
              >
              <label
                ><input
                  type="checkbox"
                  name="medicalConditions"
                  value="None of the above"
                  data-testid="none-of-the-above"
                />
                None of the above</label
              >
            </div>
          </div>

          <div
            id="conditionsDetailsSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="conditionsDetails"
              >Please provide more details about your condition(s):
              <span class="optional">(Optional)</span></label
            >
            <textarea
              id="conditionsDetails"
              name="conditionsDetails"
              rows="3"
              maxlength="1000"
              placeholder="e.g., Diagnosed with diabetes in 2020, currently managed with medication..."
            ></textarea>
          </div>

          <div class="form-group" id="seenOtherProviderGroup" style="display:none;">
            <label>
              Have you seen any other healthcare provider for this?
              <span class="required">*</span>
            </label>
            <div class="radio-group inline">
              <label>
                <input type="radio" name="seenOtherProvider" value="Yes" />
                Yes
              </label>
              <label>
                <input type="radio" name="seenOtherProvider" value="No" />
                No
              </label>
            </div>
          </div>

          <div class="form-group">
            <label
              >Are you pregnant or breastfeeding?
              <span class="required">*</span></label
            >
            <div class="radio-group inline">
              <label
                ><input
                  type="radio"
                  name="pregnantBreastfeeding"
                  value="Yes"
                  required
                />
                Yes</label
              >
              <label
                ><input type="radio" name="pregnantBreastfeeding" value="No" />
                No</label
              >
              <label
                ><input
                  type="radio"
                  name="pregnantBreastfeeding"
                  value="Not applicable"
                />
                Not applicable</label
              >
            </div>
          </div>

          <div
            id="pregnancyWeeksSection"
            class="form-group hidden-field slide-field"
            style="margin-top: 12px"
          >
            <label for="pregnancy_weeks"
              >How many weeks along are you?
              <span class="optional">(Optional)</span></label
            >
            <input
              type="number"
              id="pregnancy_weeks"
              name="pregnancy_weeks"
              min="0"
              max="40"
              placeholder="e.g., 20"
              maxlength="2"
            />
          </div>

          <div class="form-group" style="margin-top: 20px">
            <label for="additionalHealthInfo"
              >Please provide any additional information that you feel is
              relevant to your health history:
              <span class="optional">(Optional)</span></label
            >
            <textarea
              id="additionalHealthInfo"
              name="additionalHealthInfo"
              rows="3"
              maxlength="1000"
              placeholder="Any other information you'd like to share..."
            ></textarea>
          </div>

          <div
            style="
              margin-top: 24px;
              padding-top: 16px;
              border-top: 1px solid var(--border-color);
              text-align: center;
            "
          >
            <p style="font-size: 13px; color: var(--text-light); margin: 0">
              Health history complete? Click <strong>Next</strong> to continue.
            </p>
          </div>
        </div>

        <!-- Step 5: Consent & Signature -->
        <div
          class="wizard-step form-section consent-section"
          data-step="5"
          data-testid="intake-step-5"
          style="
            border: 2px solid var(--accent-color);
            padding: 20px;
            border-radius: 12px;
          "
        >
          <h2>Step 5 - Consent &amp; Signature</h2>

          <div style="margin-bottom: 16px">
            <a
              href="/privacy"
              target="_blank"
              rel="noopener noreferrer"
              class="btn-secondary"
              style="width: 100%; display: inline-block; text-align: center; text-decoration: none;"
              aria-label="View Privacy Policy (opens in new tab)"
            >
              View Privacy Policy (opens in new tab)
            </a>
          </div>

          <div class="consent-checkbox">
            <label>
              <input
                type="checkbox"
                name="consentAll"
                id="consentAll"
                data-testid="consent-care"
                required
              />
              <span id="consentText"
                >I have read and understood the Privacy Policy, and I consent to the collection and use of my personal information for treatment and administrative purposes. <span class="required">*</span></span
              >
            </label>
          </div>

          <div class="consent-checkbox">
            <label>
              <input type="checkbox" name="emailOptIn" id="emailOptIn" data-testid="consent-marketing" /> I consent to receive email communication about bookings and updates from Flexion &amp; Flow.
            </label>
            <p style="font-size: 12px; color: var(--text-light); margin-top: 4px; margin-left: 24px;">
              You can withdraw this consent at any time using the unsubscribe link in emails or by contacting us.
            </p>
          </div>

          <div class="consent-checkbox">
            <label>
              <input type="checkbox" name="medicalCareDisclaimer" id="medicalCareDisclaimer" data-testid="medical-disclaimer" required />
              <span>I understand that massage is not a substitute for medical care. If I have concerns about my health, I will seek appropriate medical advice. <span class="required">*</span></span>
            </label>
          </div>

          <div class="signature-area">
            <h3 style="margin-top: 24px; margin-bottom: 12px">Signature</h3>
            <p class="section-note">
              Draw your signature below using your finger or mouse.
            </p>

            <div class="signature-draw">
              <div class="signature-container">
                <div class="signature-pad-frame">
                  <canvas id="signatureCanvas" class="signature-pad"></canvas>
                </div>
                <button type="button" id="clearSignature" class="btn-secondary">
                  Clear Signature
                </button>
              </div>
            </div>

            <input type="hidden" id="signatureData" name="signature" />
            <input type="hidden" id="signedAt" name="signedAt" />
          </div>

          <div
            style="
              margin-top: 24px;
              padding-top: 16px;
              border-top: 1px solid var(--border-color);
              text-align: center;
            "
          >
            <p style="font-size: 13px; color: var(--text-light); margin: 0">
              Everything complete? Click <strong>Submit</strong> to finish.
            </p>
          </div>
        </div>

        <!-- Sticky Action Bar (wizard controls) -->
        <div id="stepStatus" class="step-status" aria-live="polite"></div>
        <div
          class="form-actions sticky-actions wizard-bottom-bar"
          style="align-items: center"
        >
          <button
            type="button"
            id="prevBtn"
            class="btn-secondary"
            data-testid="wizard-back"
          >
            Back
          </button>
          <button
            type="button"
            id="nextBtn"
            class="btn-primary"
            data-testid="wizard-next"
          >
            Next
          </button>
          <button
            type="submit"
            id="submitBtn"
            class="btn-primary"
            style="display: none"
            data-testid="submit-intake"
          >
            Submit
          </button>
        </div>
      </form>
    </div>

    <script src="/js/auPhoneFormatter.js?v=20260127" defer></script>
    <script src="/js/signature.js?v=20260125" defer></script>
    <script src="/js/conditionalFields.js?v=20260211" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="/js/date-picker.js?v=20260203" defer></script>
    <script src="/js/wizard.js?v=20260203" defer></script>

    <!-- Terms + Privacy Modal -->
    <div
      id="termsModal"
      class="terms-modal hidden-field"
      role="dialog"
      aria-modal="true"
      aria-labelledby="termsModalTitle"
    >
      <div class="terms-backdrop"></div>
      <div class="terms-content" role="document">
        <div class="terms-header">
          <h2 id="termsModalTitle">Declaration &amp; Privacy Consent</h2>
          <button
            type="button"
            id="closeTermsBtn"
            class="btn-secondary"
            aria-label="Close"
          >
            Close
          </button>
        </div>
        <div class="terms-body">
          <div style="white-space: pre-wrap; line-height: 1.6">
            I confirm that the information I have provided in this form is true
            and complete to the best of my knowledge. I understand that it is my
            responsibility to inform the practitioner of any changes to my
            health or medical history that may affect my treatment. I
            acknowledge that my personal and health information is collected for
            the purpose of delivering safe and effective massage therapy. This
            information will be stored securely within Flexion &amp; Flow's
            authorised systems, including Google Workspace and Carepatron, in
            accordance with the Privacy Act 1988 (Cth) and the Australian
            Privacy Principles. My information will remain confidential and will
            not be disclosed to any third party without my consent, except where
            disclosure is required or authorised by law. I understand that I may
            request access to, or correction of, my records at any time by
            contacting Dylan Ennis, Owner of Flexion &amp; Flow.
          </div>
        </div>
      </div>
    </div>

    <script src="/js/termsModal.js?v=20260125" defer></script>
    <script src="/js/form-utils.js?v=20260128" defer></script>
    <script src="/js/intake-form.js?v=20260203" defer></script>

    <script>
      // Initialize intake form conditional fields
      document.addEventListener("DOMContentLoaded", () => {
        function animateReveal(section) {
          if (!section) return;
          section.classList.remove("slide-down");
          void section.offsetWidth;
          section.classList.add("slide-down");
        }

        // Toggle conditional field visibility based on Yes/No selections
        function setupConditionalField(
          radioName,
          conditionalSectionId,
          showOnValue = "Yes",
        ) {
          const radios = document.querySelectorAll(
            `input[name="${radioName}"]`,
          );
          const section = document.getElementById(conditionalSectionId);

          if (!radios.length || !section) return;

          radios.forEach((radio) => {
            radio.addEventListener("change", () => {
              if (radio.value === showOnValue && radio.checked) {
                section.classList.remove("hidden-field");
                section.style.display = "block";
                animateReveal(section);
              } else if (radio.checked) {
                section.classList.add("hidden-field");
                section.style.display = "none";
                // Clear the field when hiding
                const inputs = section.querySelectorAll("input, textarea");
                inputs.forEach((input) => {
                  if (input.type === "radio" || input.type === "checkbox") {
                    input.checked = false;
                  } else {
                    input.value = "";
                  }
                });
              }
            });
          });
        }

        // Setup all conditional fields
        setupConditionalField("previousMassage", "lastTreatmentSection", "Yes");
        setupConditionalField("takingMedications", "medicationsSection", "Yes");
        setupConditionalField("hasAllergies", "allergiesSection", "Yes");

        // Referral person field - show when Word of mouth / Friend/Family or Practitioner referral selected
        const referralRadios = document.querySelectorAll(
          'input[name="referralSource"]',
        );
        const referralPersonSection = document.getElementById("referralPersonSection");

        referralRadios.forEach((radio) => {
          radio.addEventListener("change", () => {
            const showReferralPerson =
              radio.value === "Word of mouth" ||
              radio.value === "Friend or Family Member" ||
              radio.value === "Referral from another practitioner";
            if (showReferralPerson && radio.checked) {
              referralPersonSection.classList.remove("hidden-field");
              referralPersonSection.style.display = "block";
              animateReveal(referralPersonSection);
            } else if (radio.checked) {
              referralPersonSection.classList.add("hidden-field");
              referralPersonSection.style.display = "none";
              document.getElementById("referral_person").value = "";
            }
          });
        });

        // Injuries show the details section
        const injuriesRadios = document.querySelectorAll(
          'input[name="hasRecentInjuries"]',
        );
        const detailsSection = document.getElementById(
          "conditionsDetailsSection",
        );

        // Medical conditions checkboxes - show details when conditions other than "None of the above" are checked
        const conditionCheckboxes = document.querySelectorAll(
          'input[name="medicalConditions"]',
        );

        function updateConditionsVisibility() {
          const injuriesYes = document.querySelector(
            'input[name="hasRecentInjuries"][value="Yes"]',
          )?.checked;
          const checkedConditions = document.querySelectorAll(
            'input[name="medicalConditions"]:checked',
          );
          const hasConditions = Array.from(checkedConditions).some(
            (cb) => cb.value !== "None of the above",
          );

          if (injuriesYes || hasConditions) {
            detailsSection.classList.remove("hidden-field");
            detailsSection.style.display = "block";
            animateReveal(detailsSection);
          } else {
            detailsSection.classList.add("hidden-field");
            detailsSection.style.display = "none";
          }
        }

        injuriesRadios.forEach((r) =>
          r.addEventListener("change", updateConditionsVisibility),
        );
        conditionCheckboxes.forEach((cb) =>
          cb.addEventListener("change", updateConditionsVisibility),
        );

        // Handle "None of the above" mutual exclusivity for medical conditions
        const noneOfTheAboveCheckbox = document.querySelector('input[name="medicalConditions"][value="None of the above"]');
        const otherConditionCheckboxes = document.querySelectorAll('input[name="medicalConditions"]:not([value="None of the above"])');

        function handleNoneOfTheAboveLogic() {
          if (noneOfTheAboveCheckbox && noneOfTheAboveCheckbox.checked) {
            // Uncheck all other medical conditions
            otherConditionCheckboxes.forEach((checkbox) => {
              checkbox.checked = false;
            });
          }
        }

        function handleOtherConditionsLogic() {
          // If any other condition is checked, uncheck "None of the above"
          const hasOtherConditions = Array.from(otherConditionCheckboxes).some(cb => cb.checked);
          if (hasOtherConditions && noneOfTheAboveCheckbox) {
            noneOfTheAboveCheckbox.checked = false;
          }
        }

        if (noneOfTheAboveCheckbox) {
          noneOfTheAboveCheckbox.addEventListener("change", handleNoneOfTheAboveLogic);
        }

        otherConditionCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", handleOtherConditionsLogic);
        });

        // Slider value display updates
        const sliders = [
          { id: "sleepQuality", valueId: "sleepQualityValue" },
          { id: "stressLevel", valueId: "stressLevelValue" },
          { id: "painLevel", valueId: "painLevelValue" },
        ];

        sliders.forEach(({ id, valueId }) => {
          const slider = document.getElementById(id);
          const valueDisplay = document.getElementById(valueId);
          if (slider && valueDisplay) {
            // Show nothing until user interacts
            valueDisplay.textContent = "";
            slider.value = "";
            slider.addEventListener("input", () => {
              valueDisplay.textContent = slider.value;
            });
          }
        });

        // Pain descriptors "I'd rather tell you in person" logic
        const painDescriptorCheckboxes = document.querySelectorAll('input[name="painDescriptors"]');
        const tellInPersonCheckbox = document.querySelector('input[name="painDescriptors"][value="tell_in_person"]');
        const painDescriptorOtherSection = document.getElementById("painDescriptorOtherSection");

        function handlePainDescriptorsVisibility() {
          if (tellInPersonCheckbox && tellInPersonCheckbox.checked) {
            // Hide and clear all other pain descriptors
            painDescriptorCheckboxes.forEach((checkbox) => {
              if (checkbox.value !== "tell_in_person") {
                checkbox.checked = false;
                checkbox.parentElement.style.opacity = "0.5";
                checkbox.disabled = true;
              }
            });
            // Hide and clear the "Other" input
            if (painDescriptorOtherSection) {
              painDescriptorOtherSection.style.display = "none";
              const otherInput = document.getElementById("painDescriptorOther");
              if (otherInput) otherInput.value = "";
            }
          } else {
            // Show all options
            painDescriptorCheckboxes.forEach((checkbox) => {
              if (checkbox.value !== "tell_in_person") {
                checkbox.parentElement.style.opacity = "1";
                checkbox.disabled = false;
              }
            });
            // Show the "Other" input
            if (painDescriptorOtherSection) {
              painDescriptorOtherSection.style.display = "block";
            }
          }
        }

        if (tellInPersonCheckbox) {
          tellInPersonCheckbox.addEventListener("change", handlePainDescriptorsVisibility);
        }
      });
    </script>
  </body>
</html>
